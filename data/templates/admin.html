<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARR Annunciator Admin Interface</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
        .section { margin-bottom: 40px; }
        .status-ok { color: green; }
        .status-error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>TARR Annunciator Admin Interface</h1>
            <div>
                <a href="/" class="btn btn-outline-secondary me-2">üè† Main Interface</a>
                <a href="/admin/logout" class="btn btn-outline-danger">üö™ Logout</a>
            </div>
        </div>
        
        <!-- Status Section -->
        <div class="alert alert-info">
            <h5>System Status</h5>
            <p><strong>Platform:</strong> <span id="platform-info">Loading...</span></p>
            <p><strong>Audio System:</strong> <span class="status-ok">Active (Beep)</span></p>
            <p><strong>Volume:</strong> <span id="current-volume">{{printf "%.0f" (mul .current_volume 100)}}%</span></p>
            <p><strong>Selected Device:</strong> <span id="selected-device-info">{{.selected_audio_device}}</span></p>
            <p><strong>Scheduler:</strong> <span class="status-ok">Running</span></p>
            <p><strong>Web Interface:</strong> <a href="/" target="_blank">http://localhost:8080</a></p>
        </div>

        <!-- Audio Controls Section -->
        <div class="section">
            <h3>üîä Audio Controls</h3>
            
            <!-- Volume Control -->
            <div class="mb-3">
                <label for="volume-slider" class="form-label">Volume: <span id="volume-display">{{printf "%.0f" (mul .current_volume 100)}}%</span></label>
                <input type="range" class="form-range" id="volume-slider" min="0" max="100" value="{{printf "%.0f" (mul .current_volume 100)}}">
                <div class="d-flex justify-content-between">
                    <small class="text-muted">0%</small>
                    <small class="text-muted">100%</small>
                </div>
            </div>

            <!-- Audio Device Selection -->
            <div class="mb-3">
                <label for="audio-device-select" class="form-label">Audio Output Device</label>
                <select class="form-select" id="audio-device-select">
                    {{range .audio_devices}}
                        <option value="{{.ID}}" {{if eq .ID $.selected_audio_device}}selected{{end}}>
                            {{.Name}}{{if .IsDefault}} (Default){{end}}
                        </option>
                    {{end}}
                </select>
            </div>

            <!-- Audio Test Button -->
            <button type="button" class="btn btn-secondary" id="test-audio-btn">üîä Test Audio</button>
            
            <div id="audio-message" class="mt-2"></div>
        </div>

        <!-- Announcement Queue Status -->
        <div class="section">
            <h3>üìã Announcement Queue</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Queue Status</h5>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-queue-btn">üîÑ Refresh</button>
                        </div>
                        <div class="card-body">
                            <div id="queue-status-content">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Recent History</h5>
                        </div>
                        <div class="card-body">
                            <div id="queue-history-content">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Announcement Controls -->
            <div class="mt-3">
                <h6>üö® Emergency Announcements</h6>
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="emergency-select" class="form-label">Emergency Type</label>
                        <select class="form-select" id="emergency-select">
                            <option value="">Select emergency type...</option>
                            {{range .emergencies}}
                                <option value="{{.ID}}" data-name="{{.Name}}" data-description="{{.Description}}" data-category="{{.Category}}">
                                    {{.Name}} ({{.Category}})
                                </option>
                            {{end}}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-danger w-100" id="emergency-announce-btn" disabled>
                            üö® TRIGGER EMERGENCY
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="queue-message" class="mt-2"></div>
        </div>

        <!-- Schedule Management -->
        <div class="section">
            <h3>‚è∞ Schedule Management</h3>
            <form method="post" action="/admin">
                <div class="mb-3">
                    <label for="cron_json" class="form-label">Schedule Configuration (JSON):</label>
                    <textarea name="cron_json" class="form-control">{{printf "%s" .cron_data}}</textarea>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Update Schedule</button>
            </form>
        </div>

        <!-- Multi-User & API Management Section -->
        <div class="section">
            <h3>üîê User & API Management</h3>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-3" id="management-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-panel" type="button" role="tab">üë• Admin Users</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="apikeys-tab" data-bs-toggle="tab" data-bs-target="#apikeys-panel" type="button" role="tab">üîë API Keys</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">‚öôÔ∏è Settings</button>
                </li>
            </ul>

            <div class="tab-content" id="management-tab-content">
                <!-- Admin Users Panel -->
                <div class="tab-pane fade show active" id="users-panel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Admin Users</h5>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#userModal">‚ûï Add User</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="users-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr><td colspan="7" class="text-center">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- API Keys Panel -->
                <div class="tab-pane fade" id="apikeys-panel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>API Keys</h5>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#apiKeyModal">‚ûï Add API Key</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="apikeys-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Key Preview</th>
                                    <th>Status</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                    <th>Last Used</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="apikeys-table-body">
                                <tr><td colspan="8" class="text-center">Loading API keys...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="tab-pane fade" id="settings-panel" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Security Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="session-timeout" class="form-label">Session Timeout (minutes)</label>
                                        <input type="number" class="form-control" id="session-timeout" min="5" max="1440" placeholder="60">
                                    </div>
                                    <button type="button" class="btn btn-primary" id="update-settings-btn">üíæ Save Settings</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">System Status</h6>
                                </div>
                                <div class="card-body" id="system-status">
                                    <p><strong>Total Users:</strong> <span id="total-users">-</span></p>
                                    <p><strong>Active API Keys:</strong> <span id="active-api-keys">-</span></p>
                                    <p><strong>Last Modified:</strong> <span id="last-modified">Loading...</span></p>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-status-btn">üîÑ Refresh</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="management-message" class="mt-2"></div>
        </div>

        <!-- User Modal -->
        <div class="modal fade" id="userModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add/Edit User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="user-id" name="id">
                            <div class="mb-3">
                                <label for="user-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="user-username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="user-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="user-password" name="password">
                                <small class="text-muted">Leave blank to keep current password (for editing)</small>
                            </div>
                            <div class="mb-3">
                                <label for="user-role" class="form-label">Role</label>
                                <select class="form-select" id="user-role" name="role">
                                    <option value="admin">Administrator</option>
                                    <option value="operator">Operator</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Permissions</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-system-config" value="system_config">
                                    <label class="form-check-label" for="perm-system-config">System Configuration</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-user-management" value="user_management">
                                    <label class="form-check-label" for="perm-user-management">User Management</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-api-management" value="api_management">
                                    <label class="form-check-label" for="perm-api-management">API Management</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-audio-control" value="audio_control">
                                    <label class="form-check-label" for="perm-audio-control">Audio Control</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-announcements" value="announcements">
                                    <label class="form-check-label" for="perm-announcements">Announcements</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="user-enabled" name="enabled" checked>
                                    <label class="form-check-label" for="user-enabled">User Enabled</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-user-btn">Save User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Key Modal -->
        <div class="modal fade" id="apiKeyModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add/Edit API Key</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="apiKeyForm">
                            <input type="hidden" id="apikey-id" name="id">
                            <div class="mb-3">
                                <label for="apikey-name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="apikey-name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="apikey-key" class="form-label">API Key</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="apikey-key" name="key" required>
                                    <button type="button" class="btn btn-outline-secondary" id="generate-key-btn">üé≤ Generate</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Permissions</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="api-perm-announce" value="announce">
                                    <label class="form-check-label" for="api-perm-announce">Announcements</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="api-perm-status" value="status">
                                    <label class="form-check-label" for="api-perm-status">Status</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="api-perm-config" value="config">
                                    <label class="form-check-label" for="api-perm-config">Configuration</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="api-perm-queue" value="queue">
                                    <label class="form-check-label" for="api-perm-queue">Queue Management</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="apikey-permanent" name="permanent">
                                    <label class="form-check-label" for="apikey-permanent">Permanent Key (Never Expires)</label>
                                </div>
                            </div>
                            <div class="mb-3" id="expiry-section">
                                <label for="apikey-expires" class="form-label">Expires At (optional)</label>
                                <input type="datetime-local" class="form-control" id="apikey-expires" name="expires_at">
                            </div>
                            <div class="mb-3">
                                <label for="apikey-rate-limit" class="form-label">Rate Limit (requests per hour)</label>
                                <input type="number" class="form-control" id="apikey-rate-limit" name="rate_limit" min="1" max="10000" value="1000">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="apikey-enabled" name="enabled" checked>
                                    <label class="form-check-label" for="apikey-enabled">API Key Enabled</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-apikey-btn">Save API Key</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Reference -->
        <div class="section">
            <h3>Available Configuration Options</h3>
            <div class="row">
                <div class="col-md-4">
                    <h5>Trains</h5>
                    <ul class="list-unstyled">
                        {{range .trains}}
                            <li>{{.ID}} - {{.Name}}</li>
                        {{end}}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Destinations</h5>
                    <ul class="list-unstyled">
                        {{range .destinations}}
                            <li>{{.ID}} - {{.Name}}</li>
                        {{end}}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Tracks</h5>
                    <ul class="list-unstyled">
                        {{range .tracks}}
                            <li>{{.ID}} - {{.Name}}</li>
                        {{end}}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Platform info
        fetch('/api/platform')
        .then(response => response.json())
        .then(data => {
            const platform = data.platform_info?.platform || 'Unknown';
            const arch = data.platform_info?.arch || 'Unknown';
            document.getElementById('platform-info').textContent = `${platform}/${arch}`;
        })
        .catch(error => {
            document.getElementById('platform-info').textContent = 'Unknown';
        });

        // Audio controls
        const volumeSlider = document.getElementById('volume-slider');
        const volumeDisplay = document.getElementById('volume-display');

        volumeSlider.addEventListener('input', function() {
            volumeDisplay.textContent = this.value + '%';
        });

        volumeSlider.addEventListener('change', function() {
            const volume = this.value / 100;
            
            fetch('/audio/volume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `volume=${volume}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAudioMessage('Volume updated successfully', 'success');
                    document.getElementById('current-volume').textContent = data.volume_percent + '%';
                } else {
                    showAudioMessage('Failed to update volume', 'danger');
                }
            });
        });

        // Audio device selection
        document.getElementById('audio-device-select').addEventListener('change', function() {
            const deviceID = this.value;
            
            fetch('/audio/devices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `device_id=${deviceID}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAudioMessage(`Audio device set to: ${data.device.Name}`, 'success');
                    document.getElementById('selected-device-info').textContent = data.device.Name;
                } else {
                    showAudioMessage(`Failed to set audio device: ${data.error}`, 'danger');
                }
            });
        });

        // Test audio
        document.getElementById('test-audio-btn').addEventListener('click', function() {
            fetch('/audio/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAudioMessage('Audio test played successfully', 'success');
                } else {
                    showAudioMessage(`Audio test failed: ${data.error}`, 'danger');
                }
            });
        });

        function showAudioMessage(message, type) {
            const messageDiv = document.getElementById('audio-message');
            messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Queue management functions
        function loadQueueStatus() {
            fetch('/api/queue/status', {
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('queue-status-content');
                if (data.error) {
                    content.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                    return;
                }

                if (data.queue && data.queue.length > 0) {
                    let html = '<div class="list-group">';
                    data.queue.forEach(item => {
                        const priorityBadge = item.priority === 1 ? 'danger' : item.priority === 2 ? 'warning' : 'primary';
                        const priorityText = item.priority === 1 ? 'EMERGENCY' : item.priority === 2 ? 'High' : item.priority === 3 ? 'Normal' : 'Low';
                        
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${item.name || item.type}</h6>
                                        <small class="text-muted">ID: ${item.id}</small>
                                    </div>
                                    <span class="badge bg-${priorityBadge}">${priorityText}</span>
                                </div>
                                <p class="mb-1"><small>Status: ${item.status}</small></p>
                                <small class="text-muted">Scheduled: ${new Date(item.scheduled_time).toLocaleString()}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<p class="text-muted">Queue is empty</p>';
                }
            })
            .catch(error => {
                document.getElementById('queue-status-content').innerHTML = '<p class="text-danger">Failed to load queue status</p>';
            });
        }

        function loadQueueHistory() {
            fetch('/api/queue/history?limit=10', {
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('queue-history-content');
                if (data.error) {
                    content.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                    return;
                }

                if (data.history && data.history.length > 0) {
                    let html = '<div class="list-group">';
                    data.history.forEach(item => {
                        const statusBadge = item.status === 'completed' ? 'success' : item.status === 'failed' ? 'danger' : 'secondary';
                        
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${item.name || item.type}</h6>
                                        <small class="text-muted">ID: ${item.id}</small>
                                    </div>
                                    <span class="badge bg-${statusBadge}">${item.status}</span>
                                </div>
                                <small class="text-muted">Completed: ${new Date(item.completed_at || item.scheduled_time).toLocaleString()}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<p class="text-muted">No recent history</p>';
                }
            })
            .catch(error => {
                document.getElementById('queue-history-content').innerHTML = '<p class="text-danger">Failed to load queue history</p>';
            });
        }

        function triggerEmergencyAnnouncement() {
            const emergencySelect = document.getElementById('emergency-select');
            const selectedValue = emergencySelect.value;
            
            if (!selectedValue) {
                showQueueMessage('Please select an emergency type', 'warning');
                return;
            }
            
            // Get emergency details
            const selectedOption = emergencySelect.options[emergencySelect.selectedIndex];
            const emergencyName = selectedOption.getAttribute('data-name');
            const emergencyDescription = selectedOption.getAttribute('data-description');
            const emergencyCategory = selectedOption.getAttribute('data-category');
            
            // Confirm the emergency
            if (!confirm(`Trigger emergency announcement:\n\n${emergencyName}\n${emergencyDescription}\n\nCategory: ${emergencyCategory}\n\nThis will have HIGHEST priority and interrupt other announcements. Continue?`)) {
                return;
            }
            
            fetch('/api/announce/emergency', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-API-Key': 'tarr-api-2025'
                },
                body: `file=${encodeURIComponent(selectedValue)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showQueueMessage(`Emergency "${data.announcement.name}" queued with highest priority!`, 'danger');
                    loadQueueStatus();
                    
                    // Reset the dropdown
                    emergencySelect.value = '';
                    document.getElementById('emergency-announce-btn').disabled = true;
                } else {
                    showQueueMessage(`Failed to queue emergency: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showQueueMessage('Error triggering emergency announcement', 'danger');
            });
        }

        function showQueueMessage(message, type) {
            const messageDiv = document.getElementById('queue-message');
            messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Event listeners for queue management
        document.getElementById('refresh-queue-btn').addEventListener('click', function() {
            loadQueueStatus();
            loadQueueHistory();
        });

        // Emergency dropdown handler
        document.getElementById('emergency-select').addEventListener('change', function() {
            const emergencyBtn = document.getElementById('emergency-announce-btn');
            emergencyBtn.disabled = this.value === '';
        });

        document.getElementById('emergency-announce-btn').addEventListener('click', triggerEmergencyAnnouncement);

        // Multi-user management functions
        let currentUsers = [];
        let currentAPIKeys = [];

        function loadManagementData() {
            fetch('/admin/credentials', {
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Management data received:', data);
                if (data.error) {
                    showManagementMessage('Failed to load management data: ' + data.error, 'danger');
                    return;
                }
                
                currentUsers = data.admin_users || [];
                currentAPIKeys = data.api_keys || [];
                
                loadUsersTable();
                loadAPIKeysTable();
                updateSystemStatus(data);
                
                // Update settings
                document.getElementById('session-timeout').value = data.session_timeout || 60;
            })
            .catch(error => {
                console.error('Error loading management data:', error);
                showManagementMessage('Error loading management data: ' + error.message, 'danger');
            });
        }

        function loadUsersTable() {
            const tbody = document.getElementById('users-table-body');
            if (currentUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = currentUsers.map(user => `
                <tr>
                    <td><strong>${user.username || 'Unknown'}</strong></td>
                    <td><span class="badge bg-${user.role === 'admin' ? 'primary' : 'secondary'}">${user.role || 'user'}</span></td>
                    <td><span class="badge bg-${user.enabled ? 'success' : 'danger'}">${user.enabled ? 'Active' : 'Disabled'}</span></td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${user.last_login ? formatDate(user.last_login) : 'Never'}</td>
                    <td><small>${(user.permissions || []).join(', ')}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${user.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')" ${currentUsers.length <= 1 ? 'disabled' : ''}>üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function loadAPIKeysTable() {
            const tbody = document.getElementById('apikeys-table-body');
            if (currentAPIKeys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No API keys found</td></tr>';
                return;
            }

            tbody.innerHTML = currentAPIKeys.map(key => `
                <tr>
                    <td><strong>${key.name || 'Unknown'}</strong></td>
                    <td><code>${key.key ? key.key.substring(0, 8) + '‚Ä¢'.repeat(8) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</code></td>
                    <td><span class="badge bg-${key.enabled ? 'success' : 'danger'}">${key.enabled ? 'Active' : 'Disabled'}</span></td>
                    <td><span class="badge bg-${key.permanent ? 'warning' : 'info'}">${key.permanent ? 'Permanent' : 'Temporary'}</span></td>
                    <td>${formatDate(key.created_at)}</td>
                    <td>${key.last_used ? formatDate(key.last_used) : 'Never'}</td>
                    <td><small>${(key.permissions || []).join(', ')}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editAPIKey('${key.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAPIKey('${key.id}')" ${key.permanent ? 'disabled title="Cannot delete permanent key"' : ''}>üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateSystemStatus(data) {
            document.getElementById('total-users').textContent = currentUsers.length;
            document.getElementById('active-api-keys').textContent = currentAPIKeys.filter(k => k.enabled).length;
            document.getElementById('last-modified').textContent = formatDate(data.last_modified) || 'Unknown';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString() + ' ' + new Date(dateString).toLocaleTimeString();
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;

            // Populate modal
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-role').value = user.role;
            document.getElementById('user-enabled').checked = user.enabled;

            // Set permissions
            const permissionCheckboxes = document.querySelectorAll('#userForm input[type="checkbox"][value]');
            permissionCheckboxes.forEach(cb => {
                cb.checked = user.permissions.includes(cb.value);
            });

            // Show modal
            document.querySelector('#userModal .modal-title').textContent = 'Edit User';
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function editAPIKey(keyId) {
            const apiKey = currentAPIKeys.find(k => k.id === keyId);
            if (!apiKey) return;

            // Populate modal
            document.getElementById('apikey-id').value = apiKey.id;
            document.getElementById('apikey-name').value = apiKey.name;
            document.getElementById('apikey-key').value = apiKey.key;
            document.getElementById('apikey-permanent').checked = apiKey.permanent;
            document.getElementById('apikey-expires').value = apiKey.expires_at || '';
            document.getElementById('apikey-rate-limit').value = apiKey.rate_limit.requests_per_hour;
            document.getElementById('apikey-enabled').checked = apiKey.enabled;

            // Set permissions
            const permissionCheckboxes = document.querySelectorAll('#apiKeyForm input[type="checkbox"][value]');
            permissionCheckboxes.forEach(cb => {
                cb.checked = apiKey.permissions.includes(cb.value);
            });

            // Show modal
            document.querySelector('#apiKeyModal .modal-title').textContent = 'Edit API Key';
            new bootstrap.Modal(document.getElementById('apiKeyModal')).show();
        }

        function saveUser() {
            const formData = new FormData(document.getElementById('userForm'));
            const userId = formData.get('id');
            const isEdit = !!userId;

            // Get permissions
            const permissions = Array.from(document.querySelectorAll('#userForm input[type="checkbox"][value]:checked'))
                .map(cb => cb.value);

            const userData = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                enabled: document.getElementById('user-enabled').checked,
                permissions: permissions
            };

            const url = isEdit ? `/admin/users/${userId}` : '/admin/users';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showManagementMessage(`User ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadManagementData();
                } else {
                    showManagementMessage(`Failed to ${isEdit ? 'update' : 'create'} user: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showManagementMessage(`Error ${isEdit ? 'updating' : 'creating'} user`, 'danger');
            });
        }

        function saveAPIKey() {
            const formData = new FormData(document.getElementById('apiKeyForm'));
            const keyId = formData.get('id');
            const isEdit = !!keyId;

            // Get permissions
            const permissions = Array.from(document.querySelectorAll('#apiKeyForm input[type="checkbox"][value]:checked'))
                .map(cb => cb.value);

            const keyData = {
                name: formData.get('name'),
                key: formData.get('key'),
                permanent: document.getElementById('apikey-permanent').checked,
                expires_at: formData.get('expires_at'),
                enabled: document.getElementById('apikey-enabled').checked,
                permissions: permissions,
                rate_limit: {
                    requests_per_hour: parseInt(formData.get('rate_limit')) || 1000,
                    enabled: false
                }
            };

            const url = isEdit ? `/admin/api-keys/${keyId}` : '/admin/api-keys';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(keyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showManagementMessage(`API key ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('apiKeyModal')).hide();
                    loadManagementData();
                } else {
                    showManagementMessage(`Failed to ${isEdit ? 'update' : 'create'} API key: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showManagementMessage(`Error ${isEdit ? 'updating' : 'creating'} API key`, 'danger');
            });
        }

        function deleteUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Delete user "${user.username}"?\n\nThis action cannot be undone.`)) return;

            fetch(`/admin/users/${userId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showManagementMessage('User deleted successfully!', 'success');
                    loadManagementData();
                } else {
                    showManagementMessage(`Failed to delete user: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showManagementMessage('Error deleting user', 'danger');
            });
        }

        function deleteAPIKey(keyId) {
            const apiKey = currentAPIKeys.find(k => k.id === keyId);
            if (!apiKey) return;

            if (!confirm(`Delete API key "${apiKey.name}"?\n\nThis action cannot be undone.`)) return;

            fetch(`/admin/api-keys/${keyId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showManagementMessage('API key deleted successfully!', 'success');
                    loadManagementData();
                } else {
                    showManagementMessage(`Failed to delete API key: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showManagementMessage('Error deleting API key', 'danger');
            });
        }

        function updateSettings() {
            const sessionTimeout = parseInt(document.getElementById('session-timeout').value);
            
            if (sessionTimeout < 5 || sessionTimeout > 1440) {
                showManagementMessage('Session timeout must be between 5 and 1440 minutes', 'warning');
                return;
            }
            
            fetch('/admin/credentials', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_timeout: sessionTimeout
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showManagementMessage('Settings updated successfully!', 'success');
                    loadManagementData();
                } else {
                    showManagementMessage(`Failed to update settings: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                showManagementMessage('Error updating settings', 'danger');
            });
        }

        function generateAPIKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
            let apiKey = 'tarr-api-';
            for (let i = 0; i < 16; i++) {
                apiKey += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('apikey-key').value = apiKey;
        }

        function showManagementMessage(message, type) {
            const messageDiv = document.getElementById('management-message');
            messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Event listeners for management functionality
        document.getElementById('save-user-btn').addEventListener('click', saveUser);
        document.getElementById('save-apikey-btn').addEventListener('click', saveAPIKey);
        document.getElementById('update-settings-btn').addEventListener('click', updateSettings);
        document.getElementById('refresh-status-btn').addEventListener('click', loadManagementData);
        document.getElementById('generate-key-btn').addEventListener('click', generateAPIKey);

        // Clear modals when they're hidden
        document.getElementById('userModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('userForm').reset();
            document.getElementById('user-id').value = '';
            document.querySelector('#userModal .modal-title').textContent = 'Add User';
        });

        document.getElementById('apiKeyModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('apiKeyForm').reset();
            document.getElementById('apikey-id').value = '';
            document.querySelector('#apiKeyModal .modal-title').textContent = 'Add API Key';
        });

        // Toggle expiry section based on permanent checkbox
        document.getElementById('apikey-permanent').addEventListener('change', function() {
            const expirySection = document.getElementById('expiry-section');
            expirySection.style.display = this.checked ? 'none' : 'block';
        });

        // Load queue data on page load and refresh every 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            loadQueueStatus();
            loadQueueHistory();
            loadManagementData();
            
            // Auto-refresh every 5 seconds
            setInterval(function() {
                loadQueueStatus();
                loadQueueHistory();
            }, 5000);
        });
    </script>
</body>
</html>